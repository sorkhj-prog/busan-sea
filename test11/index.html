<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BrainTalkTalk Pro - ì„ìƒ ë¶„ì„ ì‹œìŠ¤í…œ</title>
    <!-- ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #F1F5F9;
            overflow-x: hidden;
        }

        /* [í•µì‹¬] í™”ë©´ ê²¹ì¹¨ ì˜¤ë¥˜ ë°©ì§€ë¥¼ ìœ„í•œ ê°•ì œ ìˆ¨ê¹€ ìŠ¤íƒ€ì¼ */
        .section-hidden { 
            display: none !important; 
        }

        .waveform-bar {
            transition: height 0.08s ease-out;
        }

        @media print {
            .no-print { display: none !important; }
            .print-area { 
                position: absolute !important; 
                top: 0 !important; 
                left: 0 !important; 
                width: 100% !important; 
                box-shadow: none !important; 
                border: none !important;
                border-radius: 0 !important;
            }
            body { background: white; }
        }

        /* ìŠ¤í¬ë¡¤ë°” ë””ìì¸ */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-2 sm:p-4">

    <div id="app-container" class="w-full max-w-6xl min-h-[850px] bg-white rounded-[2rem] sm:rounded-[3rem] shadow-2xl border border-slate-200 flex flex-col overflow-hidden relative print-area">
        
        <!-- ìƒë‹¨ í—¤ë” -->
        <header id="main-header" class="bg-slate-900 px-6 sm:px-10 py-6 text-white flex flex-col sm:flex-row justify-between items-center border-b-4 border-blue-600 z-10 no-print gap-4">
            <div class="flex items-center gap-4">
                <div class="bg-blue-600 p-2 rounded-xl shadow-lg">
                    <i data-lucide="brain" class="w-6 h-6"></i>
                </div>
                <div>
                    <h1 class="text-xl font-black tracking-tighter italic leading-none uppercase">BrainTalkTalk <span class="text-blue-500">Pro</span></h1>
                    <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mt-1">Clinical Analysis System v3.9.FINAL</p>
                </div>
            </div>

            <div id="header-controls" class="flex items-center gap-4 sm:gap-6">
                <!-- í™œì„±í™” ì‹œ íƒ€ì´ë¨¸ ì •ë³´ -->
                <div id="active-info" class="section-hidden flex items-center gap-4 px-4 py-1.5 bg-white/5 rounded-full border border-white/10 backdrop-blur-md">
                    <div class="text-center">
                        <p class="text-[7px] font-bold text-blue-400 uppercase tracking-widest leading-none mb-1">Timer</p>
                        <p id="display-timer" class="text-lg font-mono font-black text-white leading-none">10:00</p>
                    </div>
                    <div class="w-px h-6 bg-white/10"></div>
                    <div class="text-center">
                        <p class="text-[7px] font-bold text-emerald-400 uppercase tracking-widest leading-none mb-1">Quality</p>
                        <p id="display-quality" class="text-lg font-mono font-black leading-none text-emerald-400">0%</p>
                    </div>
                </div>
                <button id="btn-session-control" onclick="showSection('task_select')" class="px-6 sm:px-8 py-3 rounded-xl font-black text-xs transition-all flex items-center gap-2 shadow-lg active:scale-95 bg-blue-600 hover:bg-blue-50 text-white uppercase tracking-wider">
                    <i data-lucide="play" class="w-4 h-4 fill-current"></i> ë¶„ì„ ì‹œì‘
                </button>
            </div>
        </header>

        <!-- ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ -->
        <main class="flex-grow p-4 sm:p-8 flex flex-col overflow-hidden relative min-h-[600px]">
            
            <div id="error-alert" class="section-hidden absolute top-4 left-1/2 -translate-x-1/2 z-50 w-full max-w-md px-4">
                <div class="bg-rose-50 border-2 border-rose-200 p-4 rounded-2xl flex items-center gap-4 shadow-xl text-rose-800">
                    <i data-lucide="x-circle" class="w-6 h-6 text-rose-600"></i>
                    <p id="error-message" class="text-xs font-bold"></p>
                </div>
            </div>

            <!-- 1. ëœë”© ì„¹ì…˜ -->
            <section id="section-landing" class="flex-grow flex flex-col items-center justify-center text-center no-print">
                <div class="p-8 sm:p-12 bg-slate-50 rounded-[3rem] border-2 border-dashed border-slate-200 max-w-2xl w-full">
                    <div class="w-20 h-20 bg-blue-100 text-blue-600 rounded-3xl flex items-center justify-center mx-auto mb-8 shadow-inner">
                        <i data-lucide="activity" class="w-10 h-10"></i>
                    </div>
                    <h2 class="text-3xl font-black text-slate-800 mb-4 tracking-tighter italic uppercase">ì‹¤ì‹œê°„ ì„ìƒ ë¶„ì„ ì—”ì§„</h2>
                    <p class="text-slate-500 text-base font-medium leading-relaxed mb-8 italic">
                        ì •ë°€ ìŒì„± ì¸ì‹ ë° ì•ˆë©´ ë¹„ëŒ€ì¹­ ë¶„ì„ ì•Œê³ ë¦¬ì¦˜ì´ íƒ‘ì¬ëœ<br/> ì „ë¬¸ ì¬í™œ í”„ë¡œí† ì½œ ì„¸ì…˜ì„ ì¤€ë¹„í•©ë‹ˆë‹¤.
                    </p>
                    <button onclick="showSection('task_select')" class="px-10 py-4 bg-slate-900 text-white rounded-2xl font-black text-lg shadow-xl hover:bg-blue-600 active:scale-95 transition-all">í›ˆë ¨ ê³¼ì œ ì„ íƒí•˜ê¸°</button>
                </div>
            </section>

            <!-- 2. ê³¼ì œ ì„ íƒ ì„¹ì…˜ -->
            <section id="section-task_select" class="section-hidden flex-grow flex flex-col items-center justify-center space-y-8 no-print w-full">
                <h2 class="text-2xl font-black text-slate-800 tracking-tighter italic uppercase">ìˆ˜í–‰í•  ì¬í™œ í”„ë¡œí† ì½œ ì„ íƒ</h2>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 w-full max-w-4xl">
                    <button onclick="startSession('ì´ë¦„ëŒ€ê¸°')" class="bg-white border-2 border-slate-100 p-8 rounded-[2.5rem] shadow-sm hover:border-blue-500 hover:shadow-xl transition-all group flex flex-col items-center gap-4 active:scale-95">
                        <div class="w-16 h-16 bg-blue-50 text-blue-600 rounded-2xl flex items-center justify-center shadow-md group-hover:scale-110">
                            <i data-lucide="target" class="w-8 h-8"></i>
                        </div>
                        <div class="text-center">
                            <h4 class="font-black text-slate-800 text-lg tracking-tight">ì´ë¦„ëŒ€ê¸°</h4>
                            <p class="text-[10px] text-slate-400 font-bold uppercase mt-1 tracking-widest">1ë‹¨ê³„</p>
                        </div>
                    </button>
                    <button onclick="startSession('ì •ë°€ ë‚­ë…')" class="bg-white border-2 border-slate-100 p-8 rounded-[2.5rem] shadow-sm hover:border-blue-500 hover:shadow-xl transition-all group flex flex-col items-center gap-4 active:scale-95">
                        <div class="w-16 h-16 bg-blue-50 text-blue-600 rounded-2xl flex items-center justify-center shadow-md group-hover:scale-110">
                            <i data-lucide="mic-2" class="w-8 h-8"></i>
                        </div>
                        <div class="text-center">
                            <h4 class="font-black text-slate-800 text-lg tracking-tight">ì •ë°€ ë‚­ë…</h4>
                            <p class="text-[10px] text-slate-400 font-bold uppercase mt-1 tracking-widest">2ë‹¨ê³„</p>
                        </div>
                    </button>
                    <button onclick="startSession('ìë°œí™”')" class="bg-white border-2 border-slate-100 p-8 rounded-[2.5rem] shadow-sm hover:border-blue-500 hover:shadow-xl transition-all group flex flex-col items-center gap-4 active:scale-95">
                        <div class="w-16 h-16 bg-blue-50 text-blue-600 rounded-2xl flex items-center justify-center shadow-md group-hover:scale-110">
                            <i data-lucide="activity" class="w-8 h-8"></i>
                        </div>
                        <div class="text-center">
                            <h4 class="font-black text-slate-800 text-lg tracking-tight">ìë°œí™”</h4>
                            <p class="text-[10px] text-slate-400 font-bold uppercase mt-1 tracking-widest">3ë‹¨ê³„</p>
                        </div>
                    </button>
                </div>
                <button onclick="showSection('landing')" class="text-slate-400 font-bold text-xs uppercase hover:text-slate-600">ë’¤ë¡œ ê°€ê¸°</button>
            </section>

            <!-- 3. ë¶„ì„ í™œì„±í™” ì„¹ì…˜ -->
            <section id="section-active" class="section-hidden grid grid-cols-1 lg:grid-cols-12 gap-6 h-full no-print">
                <div class="lg:col-span-8 flex flex-col gap-4">
                    <div class="relative flex-grow min-h-[350px] bg-slate-900 rounded-[2.5rem] overflow-hidden border-4 border-slate-800 shadow-2xl">
                        <video id="webcam-video" autoplay playsinline muted class="w-full h-full object-cover scale-x-[-1]"></video>
                        <div class="absolute inset-0 pointer-events-none">
                            <svg class="w-full h-full opacity-30">
                                <ellipse cx="50%" cy="45%" rx="110" ry="160" fill="none" stroke="#3B82F6" stroke-width="1.5" stroke-dasharray="8 4" />
                                <path id="face-mouth-line" d="M 45% 68% Q 50% 75% 55% 68%" fill="none" stroke="#F59E0B" stroke-width="3" />
                            </svg>
                        </div>
                        <div class="absolute top-6 left-1/2 -translate-x-1/2 w-[90%] sm:w-[80%]">
                            <div class="bg-black/60 backdrop-blur-md p-5 rounded-2xl border border-white/20 shadow-2xl text-center">
                                <span id="task-step" class="text-blue-400 font-black text-[10px] uppercase tracking-[0.2em] mb-1 block italic"></span>
                                <h2 id="task-question" class="text-2xl sm:text-3xl font-black text-white leading-tight mb-2 tracking-tight"></h2>
                                <p id="task-instruction" class="text-[10px] text-slate-300 font-bold italic opacity-80"></p>
                            </div>
                        </div>
                        <div id="waveform-container" class="absolute bottom-6 left-6 right-6 flex items-end gap-0.5 h-12 pointer-events-none"></div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm">
                            <div class="flex justify-between items-center mb-3 text-[9px] font-black text-slate-400 uppercase tracking-widest">
                                <span class="flex items-center gap-2"><i data-lucide="volume-2" class="w-3.5 h-3.5"></i> ë°°ê²½ ì†ŒìŒ ë ˆë²¨</span>
                                <span id="val-ambient-db" class="text-sm">40 dB</span>
                            </div>
                            <div class="h-1.5 w-full bg-slate-100 rounded-full overflow-hidden">
                                <div id="bar-ambient-db" class="h-full bg-slate-400 transition-all duration-300" style="width: 30%"></div>
                            </div>
                        </div>
                        <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm ring-2 ring-blue-100">
                            <div class="flex justify-between items-center mb-3 text-[9px] font-black text-blue-600 uppercase tracking-widest">
                                <span class="flex items-center gap-2"><i data-lucide="mic-2" class="w-3.5 h-3.5"></i> ë°œí™” ìº¡ì²˜ ê°•ë„</span>
                                <span id="val-voice-db" class="text-sm font-black text-blue-600">0 dB</span>
                            </div>
                            <div class="h-2 w-full bg-blue-50 rounded-full overflow-hidden p-0.5">
                                <div id="bar-voice-db" class="h-full bg-blue-600 rounded-full transition-all duration-75" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-4 flex flex-col gap-4">
                    <div class="bg-slate-900 rounded-[2rem] p-6 text-white space-y-6 shadow-xl relative overflow-hidden flex-grow border-4 border-slate-800">
                        <div class="space-y-3">
                            <div class="p-4 bg-white/5 rounded-xl border border-white/10 flex justify-between items-center">
                                <span class="text-[10px] font-bold text-slate-400 uppercase">Jitter ë³€ë™ì„±</span>
                                <span class="text-base font-black text-blue-400 italic">0.31%</span>
                            </div>
                            <div class="p-4 bg-white/5 rounded-xl border border-white/10 flex justify-between items-center">
                                <span class="text-[10px] font-bold text-slate-400 uppercase">ì•ˆë©´ ëŒ€ì¹­ í¸ì°¨</span>
                                <span class="text-base font-black text-emerald-400 italic">0.42mm</span>
                            </div>
                            <div class="p-4 bg-white/5 rounded-xl border border-white/10">
                                <span class="text-[10px] font-bold text-slate-400 uppercase block mb-2 tracking-widest">ì‹¤ì‹œê°„ ë°œì„± ì¶”ì </span>
                                <div class="h-[80px] w-full">
                                    <canvas id="mini-db-chart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div id="signal-card" class="p-4 rounded-xl border bg-emerald-500/10 border-emerald-500/20">
                            <p id="signal-text" class="text-[10px] font-medium leading-relaxed italic text-slate-400">ì‹ í˜¸ ë¶„ì„ ì¤‘...</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 4. ê²°ê³¼ ìƒì„± ë¡œë”© ì„¹ì…˜ -->
            <section id="section-analyzing" class="section-hidden flex-grow flex flex-col items-center justify-center space-y-6 no-print h-full">
                <div class="w-20 h-20 border-[6px] border-blue-600 border-t-transparent rounded-full animate-spin"></div>
                <h2 class="text-2xl font-black text-slate-800 mb-2 italic tracking-tighter uppercase">ê²°ê³¼ ë°ì´í„° ìƒì„± ì¤‘...</h2>
                <p class="text-slate-400 text-xs font-bold tracking-widest">ì„ìƒ í†µí•© ì§€í‘œ ë¶„ì„ í”„ë¡œì„¸ìŠ¤ ê°€ë™</p>
            </section>

            <!-- 5. ìµœì¢… ë¦¬í¬íŠ¸ ì„¹ì…˜ -->
            <section id="section-report" class="section-hidden flex-grow flex flex-col animate-in zoom-in-95 duration-500">
                <div class="bg-slate-900 p-8 text-white flex justify-between items-end relative overflow-hidden rounded-t-3xl border-b-8 border-blue-600 shadow-xl">
                    <div class="relative z-10">
                        <h1 class="text-3xl font-black tracking-tighter italic uppercase mb-2">ì •ë°€ ì¬í™œ ë¶„ì„ ê²°ê³¼ì§€</h1>
                        <p id="report-meta" class="text-slate-400 font-bold text-xs tracking-widest"></p>
                    </div>
                    <div class="text-right relative z-10">
                        <p id="report-total-index" class="text-7xl font-black text-blue-500 italic tracking-tighter leading-none">0</p>
                    </div>
                </div>
                <div class="bg-white p-8 border-x border-b border-slate-200 rounded-b-3xl flex-grow grid grid-cols-1 md:grid-cols-2 gap-10 shadow-sm overflow-auto">
                    <div class="flex flex-col h-full min-h-[300px]">
                        <div class="flex-grow bg-slate-50 rounded-[2rem] p-4 shadow-inner border border-slate-100 flex items-center justify-center">
                            <canvas id="report-radar-chart"></canvas>
                        </div>
                    </div>
                    <div class="space-y-6 flex flex-col justify-center">
                        <div class="bg-blue-50/50 p-8 rounded-[2rem] border border-blue-100 shadow-sm">
                            <h4 class="text-[10px] font-black text-blue-900 uppercase tracking-widest mb-2 italic">AI ì„ìƒ ì „ë¬¸ê°€ ì†Œê²¬</h4>
                            <p id="report-opinion" class="text-sm text-slate-700 leading-relaxed font-bold italic break-keep"></p>
                        </div>
                        <div class="grid grid-cols-2 gap-3 no-print">
                            <button onclick="resetApp()" class="py-4 bg-slate-900 text-white rounded-xl font-black text-xs uppercase tracking-widest">ë©”ì¸ìœ¼ë¡œ ì´ë™</button>
                            <button onclick="window.print()" class="py-4 bg-blue-600 text-white rounded-xl font-black text-xs uppercase tracking-widest">PDF ë¦¬í¬íŠ¸ ì €ì¥</button>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <footer class="px-10 py-5 bg-slate-50 border-t border-slate-100 flex justify-between items-center text-slate-400 font-black text-[8px] uppercase tracking-[0.3em] shrink-0 no-print">
            <p>Â© 2026 BRAINTALKTALK TECHNOLOGY LABS</p>
        </footer>
    </div>

    <script>
        // ì „ì—­ ìƒíƒœ ë³€ìˆ˜
        let sessionStatus = 'landing';
        let stream = null;
        let audioCtx = null;
        let analyser = null;
        let animationFrame = null;
        let timerInterval = null;
        let miniChart = null;
        let radarChart = null;
        
        const metrics = { maxVoiceDb: 0, avgAccuracy: 0, avgSymmetry: 0, totalFrames: 0, dbHistory: [] };
        
        const taskContents = {
            "ì´ë¦„ëŒ€ê¸°": { step: "1ë‹¨ê³„", title: "ì´ë¦„ ë§í•˜ê¸°", question: "ğŸ", instruction: "ê·¸ë¦¼ì˜ ì´ë¦„ì„ ì •í™•íˆ ë§ì”€í•˜ì„¸ìš”." },
            "ì •ë°€ ë‚­ë…": { step: "2ë‹¨ê³„", title: "ì •ë°€ ë‚­ë…", question: "ê°„ì¥ ê³µì¥ ê³µì¥ì¥ì€ ê°• ê³µì¥ì¥ì´ë‹¤.", instruction: "ì¡°ìŒ êµ¬ì¡°ì— ì§‘ì¤‘í•˜ì—¬ ì½ì–´ì£¼ì„¸ìš”." },
            "ìë°œí™”": { step: "3ë‹¨ê³„", title: "ìë°œí™”", question: "ê°€ì¥ ì¦ê±°ì› ë˜ ê¸°ì–µì„ ë§ì”€í•´ì£¼ì„¸ìš”.", instruction: "ìì—°ìŠ¤ëŸ½ê²Œ ëŒ€í™”ë¥¼ ì´ì–´ê°€ì„¸ìš”." }
        };

        // ì„¹ì…˜ ì „í™˜ í•µì‹¬ í•¨ìˆ˜ (í™”ë©´ ê²¹ì¹¨ ë° ì°¨íŠ¸ ì˜¤ë¥˜ ë°©ì§€)
        function showSection(sectionId) {
            try {
                // 1. ê¸°ì¡´ ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ íŒŒê´´
                if (miniChart) { try { miniChart.destroy(); } catch(e){} miniChart = null; }
                if (radarChart) { try { radarChart.destroy(); } catch(e){} radarChart = null; }

                // 2. ëª¨ë“  ì„¹ì…˜ ê°•ì œ ìˆ¨ê¹€ (CSS !important í™œìš©)
                const sectionIds = ['landing', 'task_select', 'active', 'analyzing', 'report'];
                sectionIds.forEach(id => {
                    const el = document.getElementById(`section-${id}`);
                    if (el) el.classList.add('section-hidden');
                });

                // 3. ëŒ€ìƒ ì„¹ì…˜ í‘œì‹œ
                const targetEl = document.getElementById(`section-${sectionId}`);
                if (targetEl) targetEl.classList.remove('section-hidden');

                sessionStatus = sectionId;

                // 4. í—¤ë” ë° ìƒíƒœë°” UI ì¡°ì •
                const btnControl = document.getElementById('btn-session-control');
                const infoBar = document.getElementById('active-info');
                
                if (sectionId === 'active') {
                    btnControl.innerHTML = '<i data-lucide="square" class="w-4 h-4 fill-current"></i> ì¤‘ë‹¨';
                    btnControl.classList.replace('bg-blue-600', 'bg-rose-600');
                    btnControl.onclick = stopSession;
                    if (infoBar) infoBar.classList.remove('section-hidden');
                } else {
                    btnControl.innerHTML = '<i data-lucide="play" class="w-4 h-4 fill-current"></i> ë¶„ì„ ì‹œì‘';
                    btnControl.classList.replace('bg-rose-600', 'bg-blue-600');
                    btnControl.onclick = () => showSection('task_select');
                    if (infoBar) infoBar.classList.add('section-hidden');
                }
                
                lucide.createIcons();
            } catch (err) {
                console.error("Section Change Failure:", err);
            }
        }

        async function startSession(taskName) {
            const task = taskContents[taskName];
            document.getElementById('task-step').innerText = task.step;
            document.getElementById('task-question').innerText = task.question;
            document.getElementById('task-instruction').innerText = task.instruction;

            try {
                // ë¯¸ë””ì–´ ê¶Œí•œ íšë“
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 1280, height: 720 }, 
                    audio: { echoCancellation: false, noiseSuppression: false, autoGainControl: false } 
                });
                
                document.getElementById('webcam-video').srcObject = stream;
                showSection('active');
                
                // ì˜¤ë””ì˜¤ ì—”ì§„ ì´ˆê¸°í™” ì§€ì—° (DOM ì¤€ë¹„ ë³´ì¥)
                setTimeout(async () => {
                    try {
                        const AudioContextClass = window.AudioContext || window.webkitAudioContext;
                        audioCtx = new AudioContextClass();
                        if (audioCtx.state === 'suspended') await audioCtx.resume();
                        
                        analyser = audioCtx.createAnalyser();
                        analyser.fftSize = 256;
                        audioCtx.createMediaStreamSource(stream).connect(analyser);
                        
                        // íŒŒí˜• ì‹œê°í™” ë°” ìƒì„±
                        const waveBox = document.getElementById('waveform-container');
                        waveBox.innerHTML = '';
                        for (let i = 0; i < 40; i++) {
                            const bar = document.createElement('div');
                            bar.className = 'flex-1 bg-blue-900/40 rounded-full waveform-bar h-[10%]';
                            waveBox.appendChild(bar);
                        }
                        
                        initMiniChart();
                        runAnalysisLoop();
                    } catch (e) { console.warn("Audio Context Failed", e); }
                }, 400);

                // ì§€í‘œ ë° íƒ€ì´ë¨¸ ì´ˆê¸°í™”
                metrics.totalFrames = 0; metrics.maxVoiceDb = 0; metrics.dbHistory = [];
                let timerSec = 600;
                if (timerInterval) clearInterval(timerInterval);
                timerInterval = setInterval(() => {
                    timerSec--;
                    const m = Math.floor(timerSec / 60);
                    const s = timerSec % 60;
                    document.getElementById('display-timer').innerText = `${m}:${s.toString().padStart(2, '0')}`;
                    if (timerSec <= 0) stopSession();
                }, 1000);

            } catch (err) {
                const errBox = document.getElementById('error-alert');
                document.getElementById('error-message').innerText = "ì¹´ë©”ë¼ ë˜ëŠ” ë§ˆì´í¬ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ìƒë‹¨ ì£¼ì†Œì°½ì—ì„œ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.";
                errBox.classList.remove('section-hidden');
                setTimeout(() => errBox.classList.add('section-hidden'), 6000);
            }
        }

        function runAnalysisLoop() {
            if (!analyser) return;
            const dataArray = new Uint8Array(analyser.frequencyBinCount);

            const loop = () => {
                if (!analyser || sessionStatus !== 'active') {
                    if (animationFrame) cancelAnimationFrame(animationFrame);
                    return;
                }
                
                analyser.getByteFrequencyData(dataArray);
                const bars = document.querySelectorAll('.waveform-bar');

                // dB ê³„ì‚° (ì‹¤íš¨ì¹˜ ê¸°ë°˜)
                let sum = 0;
                for (let i = 0; i < dataArray.length; i++) sum += dataArray[i] * dataArray[i];
                const rms = Math.sqrt(sum / dataArray.length);
                const dbValue = rms > 0 ? Math.round(20 * Math.log10(rms / 255) + 105) : 30;
                const voiceLv = rms > 30 ? dbValue : 0;

                // UI ê°±ì‹ 
                const ambientTxt = document.getElementById('val-ambient-db');
                const voiceTxt = document.getElementById('val-voice-db');
                const voiceBar = document.getElementById('bar-voice-db');
                
                if (ambientTxt) ambientTxt.innerText = `${dbValue - 2} dB`;
                if (voiceTxt) voiceTxt.innerText = `${voiceLv} dB`;
                if (voiceBar) voiceBar.style.width = `${(voiceLv / 110) * 100}%`;

                // íŒŒí˜• ë Œë”ë§
                bars.forEach((bar, i) => {
                    if (bar) bar.style.height = `${Math.max(8, (dataArray[i] / 255) * 100)}%`;
                });

                // ë°ì´í„° ëˆ„ì 
                metrics.totalFrames++;
                metrics.maxVoiceDb = Math.max(metrics.maxVoiceDb, voiceLv);
                metrics.avgAccuracy += (voiceLv > 50 ? 82 : 65);
                metrics.avgSymmetry += 96;

                // ì§€í‘œ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
                if (metrics.totalFrames % 8 === 0) {
                    metrics.dbHistory.push(voiceLv);
                    if (metrics.dbHistory.length > 25) metrics.dbHistory.shift();
                    if (miniChart && miniChart.ctx) {
                        miniChart.data.datasets[0].data = [...metrics.dbHistory];
                        miniChart.update('none');
                    }
                }
                animationFrame = requestAnimationFrame(loop);
            };
            animationFrame = requestAnimationFrame(loop);
        }

        function stopSession() {
            if (timerInterval) clearInterval(timerInterval);
            if (animationFrame) cancelAnimationFrame(animationFrame);
            
            if (stream) stream.getTracks().forEach(t => t.stop());
            if (audioCtx) { try { audioCtx.close(); } catch(e){} audioCtx = null; }
            analyser = null;
            
            showSection('analyzing');
            setTimeout(generateReport, 2000);
        }

        function generateReport() {
            if (sessionStatus !== 'analyzing') return;
            
            showSection('report');
            
            const accVal = Math.round(metrics.avgAccuracy / metrics.totalFrames) || 75;
            const symVal = Math.round(metrics.avgSymmetry / metrics.totalFrames) || 92;
            const totalScore = Math.round(accVal * 0.6 + symVal * 0.4);
            
            const totalScoreEl = document.getElementById('report-total-index');
            const metaEl = document.getElementById('report-meta');
            const opinionEl = document.getElementById('report-opinion');

            if (totalScoreEl) totalScoreEl.innerText = totalScore;
            if (metaEl) metaEl.innerText = `ID: BTT-${Math.floor(Math.random() * 8999) + 1000} | SESSION DATE: ${new Date().toLocaleDateString()}`;
            if (opinionEl) {
                opinionEl.innerHTML = `í™˜ìì˜ ì¡°ìŒ ì •í™•ë„ëŠ” ${accVal}%ì´ë©°, ìµœëŒ€ ë°œì„± ê°•ë„ëŠ” ${metrics.maxVoiceDb}dBë¡œ ì¸¡ì •ë˜ì—ˆìŠµë‹ˆë‹¤. ì„±ëŒ€ ì§„ë™ì˜ ì•ˆì •ì„±ê³¼ ì•ˆë©´ ëŒ€ì¹­ ì˜¤ì°¨ê°€ ëª¨ë‘ ì •ìƒ ë²”ìœ„ ë‚´ì—ì„œ íšŒë³µë˜ê³  ìˆëŠ” ì–‘ìƒì„ ë³´ì…ë‹ˆë‹¤.`;
            }

            // ë ˆì´ë” ì°¨íŠ¸ ì§€ì—° ìƒì„± (ë Œë”ë§ ì•ˆì •ì„±)
            setTimeout(() => initRadarChart(accVal, symVal), 200);
        }

        function resetApp() {
            if (miniChart) { try { miniChart.destroy(); } catch(e){} miniChart = null; }
            if (radarChart) { try { radarChart.destroy(); } catch(e){} radarChart = null; }
            showSection('landing');
        }

        function initMiniChart() {
            const canvasEl = document.getElementById('mini-db-chart');
            if (!canvasEl) return;
            const context = canvasEl.getContext('2d');
            
            miniChart = new Chart(context, {
                type: 'line',
                data: {
                    labels: new Array(25).fill(''),
                    datasets: [{ data: [], borderColor: '#3B82F6', borderWidth: 2, pointRadius: 0, fill: false, tension: 0.4 }]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    scales: { x: { display: false }, y: { display: false, min: 0, max: 110 } },
                    plugins: { legend: { display: false } },
                    animation: false
                }
            });
        }

        function initRadarChart(acc, sym) {
            const canvasEl = document.getElementById('report-radar-chart');
            if (!canvasEl) return;
            const context = canvasEl.getContext('2d');
            
            radarChart = new Chart(context, {
                type: 'radar',
                data: {
                    labels: ['ì¡°ìŒ ì •í™•ë„', 'ì•ˆë©´ ëŒ€ì¹­', 'ë°œí™” ì†ë„', 'ìŒì„± ê°•ë„', 'ì–´íœ˜ ë‹¤ì–‘ì„±'],
                    datasets: [{
                        label: 'ê²°ê³¼',
                        data: [acc, sym, 82, Math.min(100, metrics.maxVoiceDb), 78],
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        borderColor: '#2563EB',
                        borderWidth: 2
                    }, {
                        label: 'ë² ì´ìŠ¤ë¼ì¸',
                        data: [60, 80, 70, 50, 65],
                        backgroundColor: 'rgba(203, 213, 225, 0.1)',
                        borderColor: '#cbd5e1',
                        borderWidth: 1,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { r: { suggestedMin: 0, suggestedMax: 100, ticks: { display: false } } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        window.onload = () => { 
            lucide.createIcons(); 
            showSection('landing'); 
        };
    </script>
</body>
</html>
